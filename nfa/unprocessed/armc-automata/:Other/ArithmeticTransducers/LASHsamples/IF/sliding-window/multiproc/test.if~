/* 
comment:
-------
YY_MM-DD : 00-05-03 
QUEUE SIZE :3
N = 2
2 queues, message lost when queues full
4 processes 
NMAX : inf!
 

A TESTER :   steps,   kbyte(s),  seconds 

*/


system sliding;

gate
q1S(int);
q1R(int);
q2S(int);
q2R(int);

var
N(2)  : int ;
nb1(0) :int ;
nb2(0) :int ;

sync (hide q1R, q2S in sender ||| hide q2R, q1S in receiver)
 |[q1S, q1R, q2R, q2S]|
     (hide q2R, q2S in queue1 ||| hide q1R, q1S in queue2) end ;


process sender;
var
ns (0) : int ;
na (0) : int ;
ack(0): int ;

state
s_ready :init assert ((na <= ns) and (na + N >= ns))  ; end ;
s_send_q1 ;
s_rcv_q2 ;

 
transition
t1: from s_ready 
if ns < na + N 
do ns := ns + 1
to s_send_q1;

t2: from s_send_q1
if nb1 < 3
sync q1S!ns
to s_ready;

from s_send_q1
if nb1 = 3
to s_ready;

t3: from s_ready
sync q2R?ack
to s_rcv_q2;

t4: from s_rcv_q2
if ack > na
do na := ack , ns := na, ack := 0
to s_ready;

from s_rcv_q2
if ack <= na
do ack := 0
to s_ready;

process receiver;
var v(0) :int;
    msg : int;

state
s_ready :init;
s_rcv_q1 ;

transition
t1: from s_ready
sync q1R?msg
to s_rcv_q1;

t2: from s_rcv_q1
if msg = v + 1 do v := v + 1
to s_ready;

from s_rcv_q1
if msg != v + 1
to s_ready;

t3: from s_ready 
if nb2 < 3
sync q2S!v
to s_ready;


process queue1;
var
x1(0) : int;
x2(0) : int;
x3(0) : int;

state
s0 :init;
s1 :nostable;
s2 :nostable;
s_meta :nostable;

transition
t1: from s0
if nb1 = 0 sync q1S?x1
to s_meta;

from s_meta to s1;

from s0 
if nb1 = 1 sync q1S?x2
to s1;

from s0
if nb1 = 2 sync q1S?x3
to s1;

from s1
do nb1 := nb1 + 1
to s0;

t2: from s0
if nb1 > 0 sync q1R!x1
to s2;

from s2
do x1 := x2 , x2 := x3 , x3 := 0, nb1 := nb1 -1
to s0;

process queue2;
var
x1(0) : int;
x2(0) : int;
x3(0) : int;

state
s0 :init;
s1 :nostable;
s2 : nostable;
s_meta : nostable;

transition
t1: from s0
if nb2 = 0 sync q2S?x1
to s_meta;

from s_meta to s1;


from s0 
if nb2 = 1 sync q2S?x2
to s1;

from s0
if nb2 = 2 sync q2S?x3
to s1;

from s1
do nb2 := nb2 + 1
to s0;

t2: from s0
if nb2 > 0 sync q2R!x1
to s2;

from s2
do x1 := x2 , x2 := x3 , x3 := 0, nb2 := nb2 -1
to s0;

/*
meta_global
from sender.s_ready, queue1.s0, receiver.s_ready, queue2.s0  
by sender.t1, sender.t2 | queue1.t1, 
queue1.s0 , receiver.t1| queue1.t2,
queue1.s0, receiver.t2, receiver.t3 |  queue2.t1, queue2.s0,
sender.t3 | queue2.t2, queue2.s0,  sender.t4;
*//*
Tu es sur montef00 (sun4) > time
36345.0u 15.0s 25:30:39 39% 0+0k 0+0io 0pf+0w
Tu es sur montef00 (sun4) > siflash -v sliding4proc--2-3.if
Compilation statistics:
  number of gates                   : 4.
  number of processes               : 4.
  number of variables               : 14.
  total number of control locations : 11.
  number of syncronized transitions : 8.
  number of meta-transitions        : 1.
Translating the transition relation...
   with transitions                    : 3909 NDD state(s).
   with synchronised transitions       : 5645 NDD state(s).
   with transitions & meta-transitions : 14320 NDD state(s).
Translating the set of initial states...
   initial set : 55 NDD state(s).
Starting state-space exploration...
   intermediate result : 153 NDD state(s).
   intermediate result : 339 NDD state(s).
   intermediate result : 597 NDD state(s).
   intermediate result : 1069 NDD state(s).
   intermediate result : 1818 NDD state(s).
   intermediate result : 2596 NDD state(s).
   intermediate result : 3727 NDD state(s).
   intermediate result : 5133 NDD state(s).
   intermediate result : 6521 NDD state(s).
   intermediate result : 8150 NDD state(s).
   intermediate result : 9728 NDD state(s).
   intermediate result : 11527 NDD state(s).
   intermediate result : 13148 NDD state(s).
   intermediate result : 14789 NDD state(s).
   intermediate result : 16203 NDD state(s).
   intermediate result : 17274 NDD state(s).
   intermediate result : 18707 NDD state(s).
   intermediate result : 19702 NDD state(s).
   intermediate result : 20870 NDD state(s).
   intermediate result : 22045 NDD state(s).
   intermediate result : 23338 NDD state(s).
   intermediate result : 24850 NDD state(s).
   intermediate result : 26185 NDD state(s).
   intermediate result : 27824 NDD state(s).
   intermediate result : 29426 NDD state(s).
   intermediate result : 31070 NDD state(s).
   intermediate result : 32509 NDD state(s).
   intermediate result : 34114 NDD state(s).
   intermediate result : 35450 NDD state(s).
   intermediate result : 36513 NDD state(s).
   intermediate result : 37521 NDD state(s).
   intermediate result : 38384 NDD state(s).
   intermediate result : 39286 NDD state(s).
   intermediate result : 40205 NDD state(s).
   intermediate result : 41173 NDD state(s).
   intermediate result : 42015 NDD state(s).
   intermediate result : 42771 NDD state(s).
   intermediate result : 43409 NDD state(s).
   intermediate result : 44075 NDD state(s).
   intermediate result : 44633 NDD state(s).
   intermediate result : 45094 NDD state(s).
   intermediate result : 45593 NDD state(s).
   intermediate result : 46025 NDD state(s).
   intermediate result : 46485 NDD state(s).
   intermediate result : 46911 NDD state(s).
   intermediate result : 47304 NDD state(s).
   intermediate result : 47723 NDD state(s).
   intermediate result : 47970 NDD state(s).
   intermediate result : 48230 NDD state(s).
   intermediate result : 48242 NDD state(s).
   intermediate result : 48331 NDD state(s).
   intermediate result : 48342 NDD state(s).
   intermediate result : 48398 NDD state(s).
Fixpoint reached in 53 step(s).
*** Program validated.
Runtime statistics:
  residual memory : 0 byte(s).
  max memory      : 13726992 byte(s).
Tu es sur montef00 (sun4) > time
37661.0u 15.0s 25:52:42 40% 0+0k 0+0io 0pf+0w
*/